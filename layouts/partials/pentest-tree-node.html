{{- $node := .node -}}
{{- $current := .current -}}
{{- $allOpen := .allOpen | default false -}}
{{- $childrenSections := $node.Sections.ByWeight -}}
{{- $childrenPages := $node.RegularPages.ByTitle -}}
{{- $hasChildren := or (gt (len $childrenSections) 0) (gt (len $childrenPages) 0) -}}
{{- $isActive := eq $node.RelPermalink $current.RelPermalink -}}
{{- $isOpen := or $allOpen $isActive (hasPrefix $current.RelPermalink $node.RelPermalink) -}}

<li class="tree-node">
  {{- if $hasChildren -}}
    <details {{ if $isOpen }}open{{ end }}>
      <summary>
        <span class="tree-twist" aria-hidden="true"></span>
        <span class="tree-folder" aria-hidden="true"></span>
        <a class="{{ if $isActive }}is-active{{ end }}" href="{{ $node.RelPermalink }}">{{ $node.Title }}</a>
      </summary>
      <ul>
        {{- range $childrenSections -}}
          {{ partial "pentest-tree-node.html" (dict "node" . "current" $current "allOpen" $allOpen) }}
        {{- end -}}
        {{- range $childrenPages -}}
          <li class="tree-leaf">
            <span class="tree-file" aria-hidden="true"></span>
            <a class="{{ if eq .RelPermalink $current.RelPermalink }}is-active{{ end }}" href="{{ .RelPermalink }}">{{ .Title }}</a>
          </li>
        {{- end -}}
      </ul>
    </details>
  {{- else -}}
    <a class="tree-link {{ if $isActive }}is-active{{ end }}" href="{{ $node.RelPermalink }}"><span class="tree-folder" aria-hidden="true"></span>{{ $node.Title }}</a>
  {{- end -}}
</li>
